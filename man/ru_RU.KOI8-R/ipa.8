.\" Copyright (c) 2001-2003 Andrey Simonenko
.\" All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
.\" ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
.\" ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
.\" FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\" DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
.\" OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
.\" LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
.\" OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
.\" SUCH DAMAGE.
.\"
.\" @(#)$Id: ipa.8,v 1.4.2.2 2003/02/20 06:26:58 simon Exp $
.\"
.TH IPA 8 "January 14, 2003"
.SH NAME
ipa \- утилита учёта IP трафика
.SH SYNOPSIS
\fBipa\fP\ [\fB-hVv\fP]
.br
\fBipa\fP\ [\fB-c\fP\ <директория>]\ [\fB-p\fP\ <pid-файл>]\ \fB-k\fP\ <сигнал>
.br
\fBipa\fP\ [\fB-c\fP\ <директория>]\ \fB-t\fP\ [\fB-t\fP]\ [\fB-f\fP\ <конф-файл>]
.br
\fBipa\fP\ [\fB-d\fP]\ [\fB-c\fP\ <директория>]\ [\fB-f\fP <конф-файл>]
.br
\ \ \ \ [\fB-p\fP\ <pid-файл>]\ [\fB-L\fP\ <log-facility>]
.br
\fBipa\fP\ [\fB-c\fP\ <директория>]\ [\fB-f\fP\ <конф-файл>]
.br
\ \ \ \ [\fB-r\fP\ <правило>\ [\fB-l\fP\ <лимит>]]\ секция\ [подсекция]
.SH DESCRIPTION
\fBipa\fP позволяет производить учёт IP трафика на основании значений счётчиков
правил FreeBSD IPv4/v6 Firewall (IPFW), OpenBSD Packet Filter (PF) и
IP Filter (IPF) в FreeBSD, NetBSD и OpenBSD, сохраняет накопленную информацию в базе данных,
поддерживает блокировку базы данных, позволяет устанавливать лимиты для каждого
учётного правила, понимает временные интервалы "конец дня", "конец недели" и
т.д. \fBipa\fP(8) считывает свою конфигурацию из файла
\fB/usr/local/etc/ipa.conf\fP, или из файла указанного в командной строке. Для
более детального описания возможностей \fBipa\fP(8) прочтите man-страницу
\fBipa.conf\fP(5).
.PP
Если утилита \fBipa\fP(8) была скомпилирована с опцией \fB-DIPFW2\fP на
FreeBSD 4.x, то в этом случае будет использоваться IPFW2.
.PP
Только супер-пользователь может воспользоваться всеми возможностями
\fBipa\fP(8), остальные пользователи могут использовать эту утилиту только
для тестирования конфигурационного файла, вывода её версии и вывода
информации о доступных опциях.
.PP
Вся статистика, накопленная \fBipa\fP(8), сохраняется в директории
\fB/var/ipa\fP по умолчанию, или в другой директории, определённой в параметре
\fBdb_dir\fP в конфигурационном файле.
Существует специальная программа \fBipastat\fP(8) для чтения и вывода
статистики. Чтобы разрешить доступ к статистике не только супер-пользователю,
но и другим пользователям установите соответствующие параметры
\fBdb_group\fP в конфигурационном файле (прочтите об этом параметре
на man-странице \fBipa.conf\fP(5)). Подробная
информация о реализации самой базы данных доступна на man-странице \fBipa\fP(5).
.PP
\fBipa\fP(8) блокирует на запись файл \fB/var/run/ipa.pid\fP чтобы избежать
запуска нескольких своих копий и сохраняет свой PID в этом файле.
.PP
Доступные опции:
.IP \fB-c\fP\ <директория>
Определяет <директорию>, для которой \fBipa\fP(8) сразу же вызовет функцию
chroot(2).
.IP \fB-d\fP
Не переходить в фоновый режим, выводить все сообщения в stderr, а также в
syslog. Эта опция полезна для отладки конфигурационного файла и для
тестирования правил IPFW/IPF/PF.
.IP \fB-f\fP\ <конф-файл>
Использовать данный конфигурационный файл вместо конфигурационного файла
\fB/usr/local/etc/ipa.conf\fP, используемого по умолчанию. \fINOTE\fP:
конфигурационный файл должен быть дан с абсолютным путевым именем (т.е.
начинаться с символа `/').
.IP \fB-h\fP
Вывести информацию о доступных опциях и завершить работу.
.IP \fB-k\fP\ <сигнал>
Послать <сигнал> запущенной копии \fBipa\fP(8). Доступны следующие аргументы:
\fBshutdown\fP (послать сигнал TERM), \fBreconfigure\fP (послать сигнал HUP),
\fBkill\fP (послать сигнал KILL), \fBdump\fP (послать сигнал USR1). PID
запущенной копии берётся из файла \fB/var/run/ipa.pid\fP или из другого,
заданного в опции \fB-p\fP. \fINOTE\fP: не используйте сигнал KILL чтобы
остановить \fBipa\fP(8), используйте этот сигнал только тогда, когда
\fBipa\fP(8) не работает должным образом или не перехватывает сигнал TERM (или
сигнал INT, если \fBipa\fP(8) была запущена в интерактивном режиме).
\fBipa\fP(8) не будет посылать никаких сигналов, если соответствующий PID-файл
не заблокирован на запись.
.IP \fB-L\fP\ <log-facility>
Использовать данный syslog <log-facility>, вместо "ipa", заданного по умолчанию.
.IP \fB-p\fP\ <pid-файл>
Использовать данный <pid-файл>, вместо \fB/var/run/ipa.pid\fP. Эта опция
позволяет запускать несколько копий \fBipa\fP(8) одновременно (возможно в целях
тестирования). Если опция \fB-p\fP используется совместно с опцией \fB-k\fP,
то \fB-p\fP опция должна быть указана первой.
.IP \fB-r\fP\ <правило>\ [\fB-l\fP\ <лимит>]
Определяет <правило> (и <лимит>) из которого следующая секция (и подсекция)
должна быть взята.
.IP \fB-t\fP
Прочитать конфигурационный файл и проверить его на правильность (берётся
конфигурационный файл, заданный по умолчанию, или конфигурационный файл,
заданный в опции \fB-f\fP), вывести его содержимое и завершить работу.
Выведенное содержимое конфигурационного файла форматируется и может быть
использовано как оригинальный конфигурационный файл. Например, запустите:

	$ ipa -t -f some-config-file > ipa.conf

чтобы получить отформатированную версию конфигурационного файла
some-config-file.
.IP
Если воспользоваться двумя ключами \fB-tt\fP, тогда \fBipa\fP(8) включит все
конфигурационные файлы из секции(й) \fBinclude\fP и проверит их как один
конфигурационный файл. В этом случае \fBipa\fP(8) также выведет информацию
о всех включённых и не включённых файлах в комментариях.
.IP \fB-V\fP
Вывести информацию о \fBipa\fP(8) и о поддерживаемых систем учёта трафика.
.IP \fB-v\fP
Вывести номер версии и завершить работу.
.IP секция\ [подсекция]
Запустить команды из заданной секции: startup или shutdown (подсекция
может быть if_limit_is_reached или if_limit_is_not_reached), reach или
expire. Возможно использовать сокращённые формы имён подсекций, прочтите об
этом в man-странице \fBipa.conf\fP(5).
.PP
\fBipa\fP(8) воспринимает сигналы \fBTERM\fP, \fBHUP\fP и \fBUSR1\fP (также сигнал
\fBINT\fP, если запущена в интерактивном режиме). Запущенна копия \fBipa\fP(8)
завершает свою работу если получит сигнал \fBTERM\fP (или \fBINT\fP). Это
единственный правильный метод завершения работы \fBipa\fP(8): сбрасываются все
счётчики и закрываются файлы базы данных. Сигнал \fBTERM\fP посылается
автоматически всем процессам, когда BSD система завершает свою работу и обычно
нет смысла писать какие-либо скрипты, чтобы послать сигнал \fBTERM\fP
запущенной копии \fBipa\fP(8). \fINOTE\fP: \fBsyslogd\fP(8) обычно завершает
свою работу первым, поэтому \fBipa\fP(8) может не успеть послать последние
сообщения в syslog. Если в командной строке указан ключ \fB-d\fP, тогда сигнал
\fBINT\fP обрабатывается также, как и сигнал \fBTERM\fP (сигнал \fBINT\fP
обычно посылается программе запущенной в интерактивном режиме, если набрать
последовательность Control-C на клавиатуре).
.PP
Сигнал \fBUSR1\fP указывает \fBipa\fP(8) сохранить текущее состояние счётчиков
в базу данных, что позволяет сохранять больше информации при перезагрузке
учётных правил IPFW/IPF/PF. Вам следует
подождать некоторое время (это зависит от вашего конфигурационного файла),
чтобы быть уверенным, что \fBipa\fP(8) сохранила всю учётную информацию в базе
данных.
.PP
Если послать сигнал \fBHUP\fP, то \fBipa\fP(8) перечитает конфигурационный файл
(заданный по умолчанию или определённый в командной строке, когда запускалась
\fBipa\fP(8)). Запущенная копия \fBipa\fP(8) начнёт использовать новые
установки, только в том случае, если не будет обнаружено никаких ошибок в
перечитанном конфигурационном файле. Если будет обнаружена ошибка в процессе
обработки нового конфигурационного файла, то \fBipa\fP(8) продолжит
использовать старые установки. \fBipa\fP(8) также продолжит использовать старые
установки, если права доступа к конфигурационному файлу не соответствую
правильным (см. man-страницу \fBipa.conf\fP(5)). Не все установки вновь
перечитанного конфигурационного файла будут иметь силу, для получения большей
информации по этому поводу обратитесь к man-странице \fBipa.conf\fP(5).
.PP
\fBipa\fP(8) посылает все информационные сообщения в \fBsyslogd\fP(8). Поэтому,
перед первым запуском \fBipa\fP(8) лучше добавить следующие строки в файл
\fBsyslog.conf\fP(5):
.PP
!ipa
.br
*.*<TAB>/var/log/ipa.log
.PP
затем создать log-файл:
.PP
# touch /var/log/ipa.log
.PP
и перезапустить \fBsyslogd\fP(8). Если ваша система не поддерживает такой
синтакс \fBsyslog.conf\fP(5), то вы можете определить корректный для вашей
системы log-facility с помощью опции \fB-L\fP.
.PP
Лог-сообщения посылаемые \fBipa\fP(8) имеют следующие уровни: LOG_INFO (обычные
сообщения), LOG_WARNING (какое-то IPFW/IPF/PF правило не существует,
было удалено, было добавлено, и т.д.) и LOG_ERR (что-то действительно
серьёзное). Если \fBipa\fP(8) посылает лог-сообщение с уровнем LOG_ERR,
то скорее всего \fBipa\fP(8) вскоре завершит свою работу.
.PP
\fBipa\fP(8) завершает свою работу с кодом возврата 0 или с кодом возврата
отличным от 0, если произошла какая-то ошибка (обычно это ошибочный формат
конфигурационного файла). \fINOTE\fP: по умолчанию \fBipa\fP(8) запускается в
фоновом режиме и вам не следует полагаться на возвращаемый код (это всего лишь
код возврата исходного процесса), лучше посмотреть на лог-файл.
.SH IMPLEMENTATION NOTES
\fBipa\fP(8) позволяет делать учёт IP трафика на основании значений счётчиков
правил FreeBSD IPv4/v6 Firewall, OpenBSD Packet Filter или IP Filter. Поэтому,
если поддержка FreeBSD IPv4/v6 Firewall, OpenBSD Packet Filter или IP Filter
ещё не добавлена в ядро вашей системы, то вам следует
сделать это, пересобрать ядро и перезапустить систему. Также необходимо
установить правила учёта трафика. Обратитесь к man-странице
\fBipa.conf\fP(5) чтобы узнать где эти правила лучше всего устанавливать.
.PP
IPv4 Firewall впервые появился в FreeBSD 2.0. IPv6 Firewall впервые появился
в FreeBSD 4.0, но из-за ошибки в его коде, \fBipa\fP(8) (при установке
по умолчанию) работает с ним после FreeBSD 4.2-RELEASE.
.PP
FreeBSD IPFW2 впервые появился летом 2002 г.
.PP
Packet Filter впервые появился в OpenBSD 3.0.
.PP
IP Filter поддерживает FreeBSD, NetBSD и OpenBSD. IP Filter был удалён
из дистрибутива OpenBSD начиная с OpenBSD 3.0.
.PP
Если вы установили ядро с новой реализацией IPFW/IPF/PF,
то вам следует также переустановить \fBipa\fP(8), так как \fBipa\fP(8)
использует IPFW/IPF/PF структуры ядра (т.е. структуры из некоторых
файлов-заголовков языка C) и они могут меняться от одной версии
операционной системы к другой версии, но см. ниже.
.PP
Не следует переустанавливать \fBipa\fP(8) если вы сделали изменения в ядре
операционной системы и эти изменения не повлекли к изменениям в
IPFW/IPF/PF частях ядра.
.SH FILES
/var/run/ipa.pid
.br
/var/ipa/
.br
/usr/local/etc/ipa.conf
.br
${PREFIX}/etc/ipa.conf.default
.br
${PREFIX}/share/examples/ipa/
.PP
(по умолчанию ${PREFIX} это /usr/local)
.SH SEE ALSO
ipa(5), ipa.conf(5), ipastat(8), ipf(1), ipfw(8), ip6fw(8), pf(4), pf.conf(5),
pfctl(8), syslogd(8)
.SH AUTHOR
Andrey\ Simonenko\ <simon@comsys.ntu-kpi.kiev.ua>
.SH BUGS
Если вы обнаружите какие-либо ошибки, то, пожалуйста, сообщите мне по email.
