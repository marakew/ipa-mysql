.\" Copyright (c) 2001-2003 Andrey Simonenko
.\" All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
.\" ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
.\" ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
.\" FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\" DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
.\" OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
.\" LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
.\" OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
.\" SUCH DAMAGE.
.\"
.\" @(#)$Id: ipa.5,v 1.4.2.3 2003/04/17 20:47:43 simon Exp $
.\"
.TH IPA 5 "April 17, 2003"
.SH NAME
ipa \- реализация базы данных для ipa(8)
.SH DESCRIPTION
Реализация базы данных для \fBipa\fP(8) и её формат рассмотрены в этой
man-странице для разработчиков, которые хотят разрабатывать программное
обеспечение основанное на этой базе данных, а также для администраторов,
которые хотят исправить что-то в базе данных.
.PP
Вся статистика учёта по умолчанию сохраняется в директории \fB/var/ipa\fP или
в другой директории, определённой в конфигурационном файле в параметре
\fBdb_dir\fP (см. man-страницу \fBipa.conf\fP(5) для большей информации).
.PP
Так как главная директория для базы данных может отличаться от заданной по
умолчанию, будем использовать имя \fBIPADIR\fP, вместо имени директории базы
данных.
.PP
Директория \fBIPADIR\fP содержит директории, названные именами правил. Если вы
уберёте какое-то <правило> из конфигурационного файла и вы больше не хотите
хранить статистику для этого <правила>, тогда вы можете спокойно удалить
директорию \fBIPADIR/<правило>\fP.
.PP
Каждая директория \fBIPADIR/<правило>\fP содержит файлы и директории.
Если имя директории состоит только из цифр, тогда эта директория содержит
файлы со статистикой за год. Номер года равен номеру, записанному в имени
соответствующей директории. Такие директории содержат только файлы, имя каждого
файла состоит из двух цифр. Эти файлы содержат статистику за месяц, номера
месяцев равны номерам, записанным в именах соответствующих файлов. Если вы не
хотите хранить статистику за какие-то года или за какие-то месяца, тогда вы
можете удалить соответствующие директрории или файлы. \fINOTE\fP: не удаляйте
директории для текущего года и файлы для текущего месяца, если \fBipa\fP(8)
запущена.
.PP
Файл \fBIPADIR/<правило>/info\fP содержит текстовую информацию о <правиле> и
перезаписывается каждый раз, когда \fBipa\fP(8) запускается или перечитывает
конфигурационный файл. Информация для этого файла берётся из значения
соответствующего параметра \fBinfo\fP в конфигурационном файле.
.PP
\fINOTE\fP: если вы удалили какой-то параметр \fBinfo\fP из
конфигурационного файла, то не требуется удалять соответствующий файл
из базы данных, так как \fBipa\fP(8) сделает это. Это также
справедливо для файлов \fBinfo\fP в лимитах.
.PP
Каждая учётная запись в базе данных сохраняется с двумя временными отметками:
первая временная отметка равна локальному времени когда запись была добавлена
в базу данных, вторая временная отметка равна локальному времени, когда эта
запись была обновлена последний раз. \fINOTE\fP: каждая запись обновляется даже
в том случае, если сама статистика (байтовый счётчик) не изменилась. Учётная
запись имеет следующий формат:
.PP
	DD/h1:m1:s1-h2:m2:s2 xxxxxxxxxxxxxxxxxxxx\(rsn
.PP
Где DD это день, когда запись была добавлена, десятичное число x..x это текущее
значение байтового счётчика, которое занимает 20 символов. h1:m1:s1 это первая
временная отметка, а h2:m2:s2 - вторая. Основываясь на двух временных отметках
последней записи в каждом файле в базе данных, \fBipa\fP(8) проверяет
корректность дат в базе данных во время своего старта. \fBipa\fP(8) также
проверяет время и даты в процессе своей работы и если время и/или дата были
изменены и это привело к непоследовательному изменению локального времени,
тогда \fBipa\fP(8) сообщает об этом и добавляет новую запись в базу данных. Не
существует другого пути для \fBipa\fP(8) исправить такого рода проблемы. Время
UTC и/или локальное время могут изменяться такими программами, как date(1),
ntpdate(8). Временная зона сама по себе может изменить локальное время, т.е.
сделать непоследовательное изменение времени. Это не является ошибкой для
большинства программ, но для \fBipa\fP(8) это может вызвать ошибку (см.
информацию о проблемах с временем и локальной датой в секции о параметрах
\fBupdate_db_time\fP, \fBappend_db_time\fP и \fBworktime\fP в man-странице
\fBipa.conf\fP(5)). Если \fBipa\fP(8) обнаружит проблемы со временем или датой,
то вам следует самим исправить их в соответствующих файлах базы данных. Вы
можете это сделать с помощью любого текстового редактора: просто удалите
строки с неправильными датами, или отсортируйте неправильную последовательность
строк (но помните, что каждая строка должна заканчиваться символом новой
строки). \fINOTE\fP: сокрее всего вы не захотите просто удалить ошибочные
строки, так как в этом случае вы потеряете статистику. \fINOTE\fP: если
\fBipastat\fP(8) обнаружит ошибки с датами, то она не выводит статистику, но
существует ключ \fB-e\fP, который позволяет пропустить проверку дат.
.PP
Специальное значение 24:00:00 во второй временной отметке обозначает конец дня.
.PP
Директория \fBIPADIR/<правило>/limits\fP содержит директории с именами лимитов
для <правила>. Если вы удалили какой-то <лимит> из <правила> в конфигурационном
файле и вы больше не хотите хранить информацию о том лимите, то вы можете
удалить директорию \fBIPADIR/<правило>/limits/<лимит>\fP. Эти директории
содержат один или два файла.
.PP
Файл \fBIPADIR/<правило>/limits/<лимит>/limit\fP содержит статистику для
<лимита> из <правила>. \fBipa\fP(8) также может обнаружить ошибки с датами в
этом файле и вам придётся исправить эти ошибки. \fINOTE\fP: в некоторых
случаях с ошибками в датах и временных отметках \fBipa\fP(8) может сама их
исправить, но предупреждающее сообщение будет послано в syslog в информативных
целях. Каждая строка в этом файле завершается символом перевода строки. Первая
строка имеет следующий формат:
.PP
	xxxxxxxxxxxxxxxxxxxx yyyyyyyyyyyyyyyyyyyy\(rsn
.PP
Где десятичное число x..x это текущее значение байтового счётчика для лимита,
а десятичное число y..y это значение параметра \fBbyte_limit\fP для лимита.
Каждое число занимает 20 символов.
.PP
Все другие строки в этом файле имеют следующий формат:
.PP
	X YYYY.DD.MM/hh.mm.ss\(rsn
.PP
YYYY.DD.MM/hh.mm.ss это дата, когда с лимитом свершилось некоторое событие.
YYYY обычно занимает 4 символа, но не ограничивается длиной в 4 символа. Для X
доступны следующие значения `\fBs\fP', `\fBz\fP', `\fBr\fP', `\fBe\fP', `\fBx\fP'.
`\fBs\fP' является сокращением для "Start" и обозначает дату, когда счётчик
лимита был запущен. `\fBz\fP' является сокращением для "Zero" и обозначает дату,
когда лимит должен быть обнулён. `\fBr\fP' является сокращением для "Reached" и
обозначает дату, когда лимит был достигнут. `\fBe\fP' является сокращением для
"Expired" и обозначает дату, когда лимит должен быть перезапущен. `\fBx\fP'
является сокращением для "Execute" и обозначает дату, когда были запущены
команды из параметров \fBexec\fP (из секций \fBreach\fP или \fBexpire\fP).
.PP
Файл \fBIPADIR/<правило>/limits/<лимит>/info\fP содержит текстовую информацию
о <лимите> и перезаписывается каждый раз, когда \fBipa\fP(8) запускается или
перечитывает конфигурационный файл. Информация для этого файла берётся из
значения соответствующего параметра \fBinfo\fP в конфигурационном файле.
.PP
Владельцем всех директорий и файлов в базе данных является супер-пользователь.
Группы директорий и файлов определяется параметрами \fBdb_group\fP в
конфигурационном файле. "Остальным" пользователям не разрешён доступ
к какой-либо директории или файлу в базе данных (за исключением
файла \fBlock\ db\fP).
.PP
Существует специальный файл \fBIPADIR/lock\ db\fP (имя файла содержит
один символ пробела). Если какая-то программа захочет обратиться к файлам базы
данных, то она может получить разделяемую блокировку (блокировку на чтение)
на этот файл. Эта блокировка является опциональной и должна использоваться
только в том случае, если  \fBipa\fP(8) блокирует файлы в базе данных.
Прочтите man-страницу \fBipa.conf\fP(5) о преимуществах и недостатках
блокировки базы данных и о том как \fBipa\fP(8) блокирует файлы
в базе данных (параграфы о параметре \fBlock_db\fP).
.SH FILES
/var/ipa/
.br
/usr/local/etc/ipa.conf
.SH SEE ALSO
ipa(8), ipa.conf(5), ipastat(8)
.SH AUTHOR
Andrey\ Simonenko\ <simon@comsys.ntu-kpi.kiev.ua>
.SH BUGS
Если вы обнаружите какие-либо ошибки, то, пожалуйста, сообщите мне по email.
