.\" Copyright (c) 2001-2002 Andrey Simonenko
.\" All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
.\" ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
.\" IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
.\" ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
.\" FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
.\" DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
.\" OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
.\" HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
.\" LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
.\" OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
.\" SUCH DAMAGE.
.\"
.\" @(#)$Id: ipastat.8,v 1.4.2.1 2003/02/19 22:04:35 simon Exp $
.\"
.TH IPASTAT 8 "August 29, 2002"
.SH NAME
ipastat \- утилита для просмотра базы данных учёта IP трафика, созданной ipa(8)
.SH SYNOPSIS
\fBipastat\fP\ [\fB-hv\fP]
.br
\fBipastat\fP\ [\fB-abekLnqtx\fP] [\fB-AKMGT\fP]\ [\fB-d\fP\ <директория>]
.br
\ \ \ \ \ \ \ \ [\fB-p\fP\ <time-back>]\ [\fB-I\fP|\fBi\fP\ <временной-интервал>]
.br
\ \ \ \ \ \ \ \ [\fB-R\fP|\fBr\fP\ <правило>\ [\fB-l\fP <лимит>]]
.SH DESCRIPTION
\fBipastat\fP это утилита для просмотра базы данных учёта IP трафика, созданной
\fBipa(8)\fP.
.PP
Любой может использовать \fBipastat\fP(8), но чтобы просмотреть статистику
необходимо принадлежать к соответствующей группе пользователей (доступ
к статистике в базе данных определяется с помощью параметра \fBdb_group\fP
в конфигурационном файле).
.PP
Доступные опции:
.IP \fB-a\fP
Вывести имена всех правил, которые пользователь запустивший \fBipastat\fP(8)
может просматривать, или вывести имена всех лимитов для правила заданного
в опции \fB-r\fP.
.IP \fB-b\fP
Отсортировать суммарную статистику по возрастанию значений счётчиков байтов,
если указать два ключа \fB-bb\fP, то сортировка будет производится по убыванию.
Этот ключ может быть использован совместно с несколькими опциями \fB-R\fP.
.IP \fB-d\fP\ <директория>
Использовать <директорию> вместо заданной по умолчанию директории бызы данных
/var/ipa.
.IP \fB-e\fP
Не проверять даты в файлах базы данных. По умолчанию если \fBipastat\fP(8)
найдёт какую-либо ошибку в датах в файле базы данных, то \fBipastat\fP(8) не
выведет статистику и сообщит об ошибке.
.IP \fB-h\fP
Вывести информацию о доступных опциях и завершить работу.
.IP \fB-I\fP|\fBi\fP\ <временной-интервал>
Определить <временной-интервал> для выводимой статистики. Если используется
опция \fB-I\fP, то проверять вторые временные метки учётных записей в
базе данных. Если используется опция \fB-i\fP, то не проверять вторые
временные метки учётных записей в базе данных. Формат <врменного-интервала>
см. ниже. Прочтите больше о разнице между двумя этими опциями ниже.
.IP \fB-k\fP
Принимать 1K за 1000 байт и т.д.
.IP \fB-L\fP
Использовать блокировку базы данных.
.IP \fB-n\fP
При выводе результатов не форматировать выводимую информацию и не выводить
таблицы. Используйте эту опцию в том случае, если вывод программы будет
обрабатываться другой программой.
.IP \fB-p\fP\ <time-back>
Определить сколько необходимо отступить назад во времени, затем вывести
статистику. Эта опция может использоваться с опцией \fB-i\fP или \fB-I\fP.
.IP \fB-q\fP
Не читать и не выводить \fBinfo\fP файлы (позволяет умещать слишком
широкие таблицы на экране).
.IP \fB-R\fP\ <правило>
Вывести итоговую статистику для <правила>, возможно задавать несколько опций
\fB-R\fP одновременно (-R <правило1> -R <правило2> ... -R <правилоn>).
.IP \fB-r\fP\ <правило>\ [\fB-l\fP\ <лимит>]
Вывести статистику для заданного <правила>, статистика выводится по дням.
Или вывести статистику для заданного <лимита> для <правила>.
.IP \fB-t\fP
Вывести статистику для правила с указанием временных меток. Т.е. вывести
статистику в таком виде, как она сохранена в базе данных.
.IP \fB-v\fP
Вывести номер версии и завершить работу.
.IP \fB-x\fP
Трактовать имена правил как регулярные выражения POSIX \fBre_format\fP(7).
Если этот ключ используется с опцией \fB-r\fP, тогда берётся первое
подходящее правило. Если этот ключ используется с опциями \fB-R\fP, тогда
берутся все правила подходящие любому из данных регулярных выражений.
.PP
Ключи для конвертирования байтовых счётчиков:
.IP \fB-A\fP
Конвертировать значения счётчиков байтов в Тбайты, Гбайты, Мбайты, Кбайты и
байты (конвертировать полностью).
.IP \fB-K\fP|\fBM\fP|\fBG\fP|\fBT\fP
Конвертировать значения счётчиков байтов в Кбайты, Мбайты (по умолчанию),
Гбайты или Тбайты.
.PP
Статистика выводится только для временного интервала определённого в опции
\fB-i\fP или \fB-I\fP. Если опция \fB-i\fP или \fB-I\fP не указана, тогда
\fBipastat\fP(8) выводит статистику для текущего месяца. Базовый формат для
временного интервала следующий:
.PP
	Y1.M1.D1/h1:m1:s1-Y2.M2.D2/h2:m2:s2
.PP
где Y1, Y2 - года, M1, M2 - месяца, D1, D2 - дни, h1, h2 - часы, m1, m2 -
минуты и s1, s2 - секунды. Временной интервал состоит из левой и правой частей.
Дата в правой части должна быть старше или такой же как и дата в левой части.
Каждая запись в базе данных сохраняется с двумя временными отметками: первая
временная отметка равна времени когда запись была добавлена в базу данных,
вторая временная отметка равна времени когда запись была изменена последний раз.
h1:m1:s1 определяет первую временную отметку, а h2:m2:s2 определяет вторую
временную отметку. Y1.M1.D1 и Y2.M2.D2 определяют две даты. Статистика
выводится для дней находящихся в промежутке между датами Y1.M1.D1 и Y2.M2.D2 и
если первая временная отметка для найденного дня больше или равна h1:m1:s1
(имеется ввиду день Y1.M1.D1). \fBipastat\fP(8) не проверяет вторую временную
отметку пока временной интервал не будет указан в опции \fB-I\fP. Обычно нет
смысла проверять вторую временную отметку, так как если первая временная
отметка попадает в временной интервал, то и запись можно считать значимой
для пользователя. Но опция \fB-I\fP может это изменить.
.PP
Но на самом деле не требуется указывать полный формат временного интервала.
Можно упустить почти все элементы во временном интервале. Рассмотрим несколько
примеров (следующие данные могут быть использованы как в левой, так и в правой
части временного интервала):
.PP
	2000
.br
	1999.11
.br
	5
.br
	12.8
.br
	.19
.PP
Число 2000 обозначает "год 2000". Это эквивалент для 2000.01.01/00:00:00 для
левой части, т.е. начало года и эквивалент для 2000.12.31/24:00:00 для правой
части, т.е. конец последней секунды года 2000. Строка 1999.11 обозначает "11-ый
месяц года 1999". Аналогично это эквивалент для 1999.11.01/00:00:00 для левой
части и 1999.11.30/24:00:00 для правой части. Число 5 обозначает "5-ый месяц
текущего года". Это эквивалент для ????.05.01/00:00:00 для левой части и
????.05.31/24:00:00 для правой части. Строка 12.8 обозначает "8-ой день 12-го
месяца текущего года". Это эквивалент для ????.12.08/00:00:00 для левой части и
????.12.08/24:00:00 для правой части. Последняя строка .19 обозначает "19-ый
день текущего месяца". Эквиваленты для левой и правой частей аналогичны как и
для предыдущих примеров. \fINOTE\fP: год должен быть указан четырьмя или более
цифрами, месяца, дни, часы, минуты и секунды могут быть указаны одной или двумя
цифрами.
.PP
Дополнительно можно указать время после символа `\fB/\fP'. Так же можно
упустить дату и указывать только время, в этом случае время рассматривается
как время текущего дня. Рассмотрим несколько примеров (следующие данные могут
быть использованы как в левой части, так и в правой части временного
интервала):
.PP
	/12
.br
	/10:31
.br
	/9:11:01
.PP
Строка /12 обозначает "12 часов". Это эквивалент для 12:00:00 для левой части и
13:00:00 для правой части. Строка /10:31 обозначает "10 часов, 31 минута".
Это эквивалент для 10:31:00 для левой части и 10:32:00 для правой части. Строка
/9:11:01 обозначает "9 часов, 11 минут, 1 секунда". Это значение равно
9:11:01 для обоих частей.
.PP
Во всех случаях если левая часть временного интервала имеет не полный формат,
то \fBipastat\fP(8) берёт первую секунду первой минуты первого часа и т.д.
Если правая часть временного интервала имеет не полный формат, то
\fBipastat\fP(8) берёт последнюю секунду последней минуты последнего часа и
т.д. Это можно наблюдать из предыдущих примеров: строка /12 в правой части
временного интервала обозначает 13:00:00 и не обозначает 12:59:59, так как
\fBipastat\fP(8) берёт конец последней секунды, а не начало последней секунды.
.PP
Правая часть временного интервала может быть упущена. В этом случае
\fBipastat\fP(8) будет рассматривать значение правой части равной значению
левой части. Но это является корректным, например строка "2000" и строка
"2000-2000" обозначают одно и тоже - все дни в году 2000.
.PP
Рассмотрим несколько примеров временных интервалов:
.PP
	1999-2000
.PP
Это обозначает все дни от 1 января 1999 г. до полуночи 31 декабря 2000 г.
.PP
	/10
.PP
Обозначает все минуты от 10:00:00 до 11:00:00 текущего дня.
.PP
	.22/01-/20:10
.PP
Обозначает все минуты (и дни) от 1:00:00 22-го дня текущего месяца до
20:11:00 текущего дня.
.PP
\fINOTE\fP: если вторая временная отметка какой-то записи в базе данных равна
24:00:00, то её следует рассматривать как конец дня. Обычно все временные
отметки должны начинаться в 00:00:00 и заканчиваться в 24:00:00 для каждого
дня.
.PP
В опциях \fB-i\fP и \fB-I\fP можно использовать сокращённые имена месяцов.
Регистр имени месяца игнорируется. Допустимы следующие сокращения имён
месяцов: Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov и Dec.
.PP
С использованием опции \fB-p\fP <time-back> возможно делать следующие запросы к
базе данных: "статистика за предыдущий месяц", "статистика с сентября по ноябрь
предыдущего года", "статистика за предыдущую неделю". Прочтите о формате
<time-back> в секции Examples этой man-станицы.
.PP
Все результаты генерируемые \fBipastat\fP(8) форматируются и выводятся в
таблицах, до тех пор пока не будет указана опция \fB-n\fP. Если будет
обнаружена какая-либо ошибка, то \fBipastat\fP(8) выведет пустую строку (строку
без символов), выведет сообщение об ошибке, а затем выведет ещё одну пустую
строку (пустая строка на самом деле содержит один символ перевода строки `\(rsn').
Если вывод программы \fBipastat\fP(8) будет обрабатываться какой-то другой
программой, то следует использовать опцию \fB-n\fP, в результате чего
результаты становятся очень простыми для обработки: данные в каждой строке
разделяются одиночным пробелом и названия колонок таблиц не выводятся вовсе.
.PP
\fINOTE\fP: формат вывода с использованием опции \fB-n\fP немного отличается от
формат вывода без этой опции. Все изменения в формате были сделаны чтобы
упростить последующую атоматическую обработку результатов.
.PP
Обычно существуют всего две программы, которые могут одновременно обращаться к
базе данных. Это \fBipa\fP(8) и \fBipastat\fP(8). По умолчанию
утилита \fBipa\fP(8) не блокирует никакой файл, который она модифицирует,
а \fBipastat\fP(8) не блокирует никакой файл, к которому она осуществляет
доступ. \fBipastat\fP(8) будет пытается заблокировать всю базу данных
целиком и необходимые файлы если она запущена с ключём \fB-L\fP.
Если она не сможет получить блокировку в течении 10 секунд, то
\fBipastat\fP(8) выводит предупреждающее сообщение и не обращается к
базе данных вовсе. Прочтите man-страницу \fBipa.conf\fP(5) о преимуществах
и недостатках блокировки базы данных (параграфы о параметре \fBlock_db\fP).
.PP
\fBipastat\fP(8) завершает свою работу с кодом возврата 0 или с кодом возврата
отличным от 0, если произошла какая-то ошибка. \fBipastat\fP(8) также
возвращает код ошибки, если вам не разрешен просмотр статистики для
какого-то правила (лимита).
.SH EXAMPLES
Вывести статистику для правила "rule" за текущий месяц:
.PP
    $ ipastat -r rule
.PP
Вывести статистику для правила "rule" с 21-го сентября по конец ноября
текущего месяца:
.PP
    $ ipastat -r rule sep.21-nov
.PP
    или
.PP
    $ ipastat -r rule 9.21-11
.PP
Вывести статистику для правила "rule" за сентябрь 2001 года:
.PP
    $ ipastat -r rule 2001.sep
.PP
    или
.PP
    $ ipastat -r rule 2001.9
.PP
Вывести итоговую статистику для правил "rule1" и "rule2" за 2000 и 2001 года,
конвертировать счётчики в Гбайты:
.PP
    $ ipastat -R rule1 -R rule2 -i 2000-2001 -G
.PP
Вывести туже самую статистику, но отсортировать статистику по величине
счётчиков:
.PP
    $ ipastat -R rule1 -R rule2 -i 2000-2001 -G -b
.PP
Вывести статистику для правила "rule" за предыдущий месяц:
.PP
    $ ipastat -r rule -p 1m
.PP
Вывести статистику для правила "rule" с сентября по ноябрь предыдущего года:
.PP
    $ ipastat -r rule -p 1y -i sep-nov
.PP
Вывести статистику за тот же период, но двухгодичной давности:
.PP
    $ ipastat -r rule -p 2y -i sep-nov
.PP
Вывести статистику для правила "rule" за предыдущую неделю:
.PP
    $ ipastat -r rule -p 1w
.PP
Вывести статистику для правила "rule" за предыдущий день с 10:00 по 22:30
(естественно ваш конфигурационный файл должен иметь соответствующие настройки,
чтобы позволять получать такую статистику):
.PP
    $ ipastat -r rule -p 1d -i /10-/22:30
.PP
Вывести статистику для всех правил за предыдущий месяц:
.PP
    $ ipastat -x -R . -p 1m
.PP
Вывести статистику для всех правил начинающихся с "10." или заканчивающихся
на ".123" за текущий месяц:
.PP
    $ ipastat -x -R ^10\\. -R \\.123$
.PP
Вывести статистику для одного правила, которое заканчивается на "abc":
.PP
    $ ipastat -x -r abc$
.SH FILES
/var/ipa/
.br
/usr/local/etc/ipa.conf
.SH SEE ALSO
ipa.conf(5), ipa(8)
.SH AUTHOR
Andrey\ Simonenko\ <simon@comsys.ntu-kpi.kiev.ua>
.SH BUGS
Если вы обнаружите какие-либо ошибки, то, пожалуйста, сообщите мне по email.