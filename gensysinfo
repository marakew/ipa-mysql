#!/bin/sh
#
# Copyright (c) 2001-2002 Andrey Simonenko
#
# This script generates information about the system.
#
# If this script was invoked without the -DWITHOUT_IPFIL option, then
# it tries to determine if IP Filter is installed on the system,
# and if so, then it generates IP Filter version number by parsing
# ipl.h file, or output of the "/sbin/ipf -V" command. Also it tries to
# determine locations of ip_compat.h or ip_fil_compat.h and ip_fil.h files.
#
# @(#)$Id: gensysinfo,v 1.4 2002/12/19 18:56:03 simon Exp $

ECHO=/bin/echo
UNAME=/usr/bin/uname

IPL_PATH=""
IP_COMPAT_H_PATH=""
IP_FIL_H_PATH=""

WITH_IPFIL=1

check_ipfil() {
	SED=/usr/bin/sed
	AWK=/usr/bin/awk
	IPF=/sbin/ipf

	IPF_DIR="/usr/include/netinet /usr/src/sys/netinet /usr/src/sys/contrib/ipfilter/netinet"
	IPL_H=ipl.h
	IP_FIL_H=ip_fil.h
	IP_COMPAT_H="ip_compat.h ip_fil_compat.h"

	NOIPFMSG="|-- Can't determine IP Filter version number."

	${ECHO} "|--[+] Determining version of IP Filter"

	for dir in ${IPF_DIR}; do
		if [ -f ${dir}/${IPL_H} ]; then
			IPL_PATH=${dir}/${IPL_H}
			${ECHO} "|   |-- Found ${IPL_PATH}"
			IPF_VERSION_ORIG=`${SED} -n -e 's/^#[ 	]*define[	 ][	 ]*IPL_VERSION[	 ][	 ]*.*\".*v\([[:digit:]][[:digit:]]*\(\.[[:digit:]][[:digit:]]*\)*\).*\".*$/\1/p' ${IPL_PATH}`
			break
		else
			${ECHO} "|   |-- Not found ${dir}/${IPL_H}"
		fi
	done

	if [ "${IPL_PATH}" = "" ]; then
		if [ ! -f ${IPF} -o ! -x ${IPF} ]; then
			${ECHO} "|   |-- Can't find ${IPF}, or it is not executable."
			${ECHO} "|   |-- IP Filter is not installed on this system."
			WITH_IPFIL=0
			return
		else
			${ECHO} "|   |--[+] Found ${IPF}, parse output of \"${IPF} -V\" command"
			IPF_VERSION_ORIG=`${IPF} -V 2>&1 | ${SED} -n -e 's/^.*IP[ 	]*Filter.*v\([[:digit:]][[:digit:]]*\(\.[[:digit:]][[:digit:]]*\)*\).*$/\1/p' | ${SED} -e '1q'`
		fi
	fi

	IPF_VERSION_GEN=`${ECHO} ${IPF_VERSION_ORIG} | ${AWK} '
		BEGIN { FS="."
			err = 0 }
		NF == 0 { err = 2 }
		NF >= 2 && $2 > 99 { err = 1 }
		NF >= 3 && $3 > 99 { err = 1 }
		NF == 1 { printf "%d0000", $1 }
		NF == 2 { printf "%d%02d00", $1, $2 } 
		NF == 3 { printf "%d%02d%02d", $1, $2, $3 }
		END { exit err }'`
	case $? in
	1)
		${ECHO} "|       |-- Don't know how to convert IP Filter version \"${IPF_VERSION_ORIG}\""
		${ECHO} "|           to single decimal number"
		${ECHO} ${NOIPFMSG}
		exit 1
		;;
	2)
		${ECHO} "|       |-- Found IP Filter version number \"${IPF_VERSION_ORIG}\" doesn't look like version number"
		${ECHO} ${NOIPFMSG}
		exit 1
		;;
	esac
	${ECHO} "|       |-- Original IP Filter version: ${IPF_VERSION_ORIG}"
	${ECHO} "|       |-- Generated IP Filter version: ${IPF_VERSION_GEN}"

	${ECHO} "|--[+] Searching for ip_compat.h or ip_fil_compat.h file"
	for dir in ${IPF_DIR}; do
		for ip_compat_h in ${IP_COMPAT_H}; do
			if [ -f ${dir}/${ip_compat_h} ]; then
				IP_COMPAT_H_PATH=${dir}/${ip_compat_h}
				${ECHO} "|   |-- Found ${IP_COMPAT_H_PATH}"
				break
			else
				${ECHO} "|   |-- Not found ${dir}/${ip_compat_h}"
			fi
		done
		if [ "${IP_COMPAT_H_PATH}" != "" ]; then
			break
		fi
	done

	${ECHO} "|--[+] Searching for ${IP_FIL_H} file"
	for dir in ${IPF_DIR}; do
		if [ -f ${dir}/${IP_FIL_H} ]; then
			IP_FIL_H_PATH=${dir}/${IP_FIL_H}
			${ECHO} "|   |-- Found ${IP_FIL_H_PATH}"
			break
		else
			${ECHO} "|   |-- Not found ${dir}/${IP_FIL_H}"
		fi
	done
}

WITHOUT_IPFIL_OPT="-DWITHOUT_IPFIL"

while [ $# -gt 0 ]; do
	if [ "$1" = ${WITHOUT_IPFIL_OPT} ]; then
		WITH_IPFIL=0
		break
	fi
	shift
done

${ECHO} ">> Generating information about system"
SYSTEM="`${UNAME} -s`/`${UNAME} -m` `${UNAME} -r`"
${ECHO} "|-- System: ${SYSTEM}"

if [ ${WITH_IPFIL} -eq 1 ]; then
	check_ipfil
else
	${ECHO} "|-- Skip IP Filter checking: ${WITHOUT_IPFIL_OPT}"
fi

${ECHO} "|-- Generating file system.h"
${ECHO} "/* DO NOT EDIT -- this file is automatically generated */" > system.h
${ECHO} "#ifndef IPA_SYSTEM_H" >> system.h
${ECHO} "#define IPA_SYSTEM_H" >> system.h
${ECHO} "#define BUILT_FOR_SYSTEM \"${SYSTEM}\"" >> system.h
if [ ${WITH_IPFIL} -eq 1 ]; then 
	${ECHO} "#define IPF_VERSION ${IPF_VERSION_GEN}" >> system.h
	${ECHO} "#define IPF_VERSION_STR \"${IPF_VERSION_ORIG}\"" >> system.h
	if [ "${IP_COMPAT_H_PATH}" != "" ]; then
		${ECHO} "#define IP_COMPAT_H \"${IP_COMPAT_H_PATH}\"" >> system.h
	fi
	if [ "${IP_FIL_H_PATH}" != "" ]; then
		${ECHO} "#define IP_FIL_H \"${IP_FIL_H_PATH}\"" >> system.h
	fi
	${ECHO} "#define WITH_IPFIL" >> system.h
fi
${ECHO} "#endif /* IPA_SYSTEM_H */" >> system.h
